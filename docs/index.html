<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finviz Screener Comparator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .form-section {
            padding: 30px;
            background: #f8f9fa;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input[type="text"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .manual-mode {
            display: none;
        }

        .manual-mode.active {
            display: block;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9em;
            min-height: 150px;
            resize: vertical;
        }

        .btn-primary {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            padding: 30px;
            display: none;
        }

        .results.active {
            display: block;
        }

        .result-section {
            margin-bottom: 30px;
        }

        .result-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .match {
            background: #d4edda;
        }

        .no-match {
            background: #f8d7da;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìä Finviz Screener Comparator</h1>
            <p>Compara empresas con filtros de screener</p>
        </div>

        <div class="form-section">
            <div class="info">
                <strong>üí° Nota:</strong> Si el modo autom√°tico falla por CORS, usa el modo manual pegando el HTML de
                las p√°ginas.
            </div>

            <div class="mode-selector">
                <button class="mode-btn active" onclick="setMode('auto')">üöÄ Modo Autom√°tico</button>
                <button class="mode-btn" onclick="setMode('manual')">‚úã Modo Manual</button>
            </div>

            <div class="auto-mode active">
                <div class="form-group">
                    <label for="ticker">Ticker de la Empresa</label>
                    <input type="text" id="ticker" placeholder="Ej: HUBB" value="HUBB">
                    <small>Se consultar√°: https://finviz.com/quote.ashx?t=TICKER</small>
                </div>

                <div class="form-group">
                    <label for="screener-select">Screener Predefinido</label>
                    <select id="screener-select" onchange="updateScreenerURL()">
                        <option value="default">default_20251029 (Por defecto)</option>
                        <option value="custom">üîß URL Personalizada</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="screener-url">URL del Screener</label>
                    <input type="text" id="screener-url" placeholder="https://finviz.com/screener.ashx?v=211&p=w&f=..."
                        value="https://finviz.com/screener.ashx?v=211&p=w&f=cap_largeunder,fa_curratio_o1,fa_debteq_u1,fa_evsales_u6,fa_grossmargin_o10,fa_ltdebteq_u1,fa_opermargin_o5,fa_pe_u30,fa_ps_o2,sh_float_o1,sh_instown_o30,sh_relvol_o0.5,sh_short_u10,ta_averagetruerange_o1,ta_highlow52w_a5h,ta_perf_3yup,ta_perf2_1wup,ta_rsi_nos40,ta_sma20_pa&ft=4&o=-instown">
                </div>
            </div>

            <div class="manual-mode">
                <div class="form-group">
                    <label for="ticker-manual">Ticker de la Empresa</label>
                    <input type="text" id="ticker-manual" placeholder="Ej: HUBB" value="HUBB">
                </div>

                <div class="form-group">
                    <label for="screener-html">HTML del Screener</label>
                    <textarea id="screener-html"
                        placeholder="Pega aqu√≠ el HTML completo de la p√°gina del screener..."></textarea>
                    <small>Visita la URL del screener, haz clic derecho ‚Üí Ver c√≥digo fuente ‚Üí Copiar todo</small>
                </div>

                <div class="form-group">
                    <label for="stock-html">HTML de la Empresa</label>
                    <textarea id="stock-html"
                        placeholder="Pega aqu√≠ el HTML completo de la p√°gina de la empresa..."></textarea>
                    <small>Visita https://finviz.com/quote.ashx?t=TICKER ‚Üí Ver c√≥digo fuente ‚Üí Copiar todo</small>
                </div>
            </div>

            <button class="btn-primary" onclick="compareStock()">
                üîç Comparar Empresa y Screener
            </button>
        </div>

        <div class="results" id="results">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Procesando datos...</p>
            </div>

            <div id="results-content" style="display: none;">
                <div class="result-section">
                    <h2>üìã Filtros Activos del Screener</h2>
                    <table id="screener-filters">
                        <thead>
                            <tr>
                                <th>Filtro</th>
                                <th>Valor Screener</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="result-section">
                    <h2>üè¢ Comparaci√≥n con la Empresa</h2>
                    <table id="comparison-table">
                        <thead>
                            <tr>
                                <th>Filtro</th>
                                <th>Valor Screener</th>
                                <th>Valor Empresa</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mapeo de filtros de Finviz a nombres legibles y selectores
        const FILTER_MAP = {
            'cap_largeunder': { name: 'Market Cap', selector: 'Market Cap' },
            'fa_pe_u30': { name: 'P/E Ratio', selector: 'P/E' },
            'fa_ps_o2': { name: 'P/S Ratio', selector: 'P/S' },
            'fa_curratio_o1': { name: 'Current Ratio', selector: 'Current Ratio' },
            'fa_debteq_u1': { name: 'Debt/Equity', selector: 'Debt/Eq' },
            'fa_ltdebteq_u1': { name: 'LT Debt/Equity', selector: 'LT Debt/Eq' },
            'fa_grossmargin_o10': { name: 'Gross Margin', selector: 'Gross Margin' },
            'fa_opermargin_o5': { name: 'Operating Margin', selector: 'Oper. Margin' },
            'fa_evsales_u6': { name: 'EV/Sales', selector: 'EV/Sales' },
            'sh_float_o1': { name: 'Float', selector: 'Shs Float' },
            'sh_instown_o30': { name: 'Institutional Own', selector: 'Inst Own' },
            'sh_relvol_o0.5': { name: 'Relative Volume', selector: 'Rel Volume' },
            'sh_short_u10': { name: 'Short Float', selector: 'Short Float' },
            'ta_averagetruerange_o1': { name: 'Average True Range', selector: 'ATR' },
            'ta_highlow52w_a5h': { name: '52W High/Low', selector: '52W High' },
            'ta_perf_3yup': { name: 'Performance 3Y', selector: 'Perf Year' },
            'ta_perf2_1wup': { name: 'Performance Week', selector: 'Perf Week' },
            'ta_rsi_nos40': { name: 'RSI (14)', selector: 'RSI (14)' },
            'ta_sma20_pa': { name: 'SMA20', selector: 'SMA20' }
        };

        let currentMode = 'auto';

        /**
         * Cambia entre modo autom√°tico y manual
         * @param {string} mode - 'auto' o 'manual'
         */
        function setMode(mode) {
            currentMode = mode;

            // Actualizar botones
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Mostrar/ocultar secciones
            document.querySelector('.auto-mode').classList.toggle('active', mode === 'auto');
            document.querySelector('.manual-mode').classList.toggle('active', mode === 'manual');
        }

        /**
         * Actualiza la URL del screener cuando se cambia la selecci√≥n
         */
        function updateScreenerURL() {
            const select = document.getElementById('screener-select');
            const input = document.getElementById('screener-url');

            if (select.value === 'default') {
                input.value = 'https://finviz.com/screener.ashx?v=211&p=w&f=cap_largeunder,fa_curratio_o1,fa_debteq_u1,fa_evsales_u6,fa_grossmargin_o10,fa_ltdebteq_u1,fa_opermargin_o5,fa_pe_u30,fa_ps_o2,sh_float_o1,sh_instown_o30,sh_relvol_o0.5,sh_short_u10,ta_averagetruerange_o1,ta_highlow52w_a5h,ta_perf_3yup,ta_perf2_1wup,ta_rsi_nos40,ta_sma20_pa&ft=4&o=-instown';
                input.readOnly = true;
            } else {
                input.readOnly = false;
                input.focus();
            }
        }

        /**
         * Funci√≥n principal que compara la empresa con el screener
         */
        async function compareStock() {
            const results = document.getElementById('results');
            const loading = document.getElementById('loading');
            const content = document.getElementById('results-content');

            results.classList.add('active');
            loading.style.display = 'block';
            content.style.display = 'none';

            try {
                let screenerHTML, stockHTML, ticker;

                if (currentMode === 'auto') {
                    ticker = document.getElementById('ticker').value.trim().toUpperCase();
                    const screenerURL = document.getElementById('screener-url').value.trim();

                    if (!ticker || !screenerURL) {
                        throw new Error('Por favor completa todos los campos');
                    }

                    // Descargar HTMLs con proxy CORS
                    screenerHTML = await fetchWithProxy(screenerURL);
                    stockHTML = await fetchWithProxy(`https://finviz.com/quote.ashx?t=${ticker}`);
                } else {
                    ticker = document.getElementById('ticker-manual').value.trim().toUpperCase();
                    screenerHTML = document.getElementById('screener-html').value;
                    stockHTML = document.getElementById('stock-html').value;

                    if (!ticker || !screenerHTML || !stockHTML) {
                        throw new Error('Por favor completa todos los campos');
                    }
                }

                // Parsear datos
                const screenerFilters = parseScreenerFilters(screenerHTML);
                const stockData = parseStockData(stockHTML);

                // Mostrar resultados
                displayResults(screenerFilters, stockData, ticker);

                loading.style.display = 'none';
                content.style.display = 'block';

            } catch (error) {
                loading.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                console.error(error);
            }
        }

        /**
         * Descarga HTML usando proxy CORS
         * @param {string} url - URL a descargar
         * @returns {Promise<string>} HTML descargado
         */
        async function fetchWithProxy(url) {
            const proxies = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                `https://corsproxy.io/?${encodeURIComponent(url)}`
            ];

            for (const proxy of proxies) {
                try {
                    const response = await fetch(proxy);
                    if (response.ok) {
                        return await response.text();
                    }
                } catch (e) {
                    console.warn(`Proxy fallido: ${proxy}`, e);
                }
            }

            throw new Error('No se pudo descargar la p√°gina. Por favor usa el Modo Manual.');
        }

        /**
         * Parsea los filtros activos del screener desde el HTML
         * @param {string} html - HTML del screener
         * @returns {Object} Filtros activos con sus valores
         */
        function parseScreenerFilters(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const filters = {};

            // Buscar todos los selects e inputs con valores seleccionados
            doc.querySelectorAll('select.is-selected, select.is-highlight').forEach(select => {
                const filterName = select.getAttribute('data-filter');
                const selectedOption = select.querySelector('option[selected]');

                if (filterName && selectedOption && selectedOption.value) {
                    const filterKey = `${filterName}_${selectedOption.value}`;
                    if (FILTER_MAP[filterKey] || FILTER_MAP[filterName]) {
                        const info = FILTER_MAP[filterKey] || FILTER_MAP[filterName];
                        filters[info.name] = {
                            raw: filterKey,
                            value: selectedOption.textContent.trim(),
                            selector: info.selector
                        };
                    }
                }
            });

            return filters;
        }

        /**
         * Parsea los datos de la empresa desde el HTML de Finviz
         * @param {string} html - HTML de la p√°gina de la empresa
         * @returns {Object} Datos de la empresa
         */
        function parseStockData(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const data = {};

            // Buscar la tabla de snapshot con las m√©tricas
            const tables = doc.querySelectorAll('table.snapshot-table2');

            tables.forEach(table => {
                const rows = table.querySelectorAll('tr');

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');

                    for (let i = 0; i < cells.length; i += 2) {
                        if (cells[i] && cells[i + 1]) {
                            const key = cells[i].textContent.trim();
                            const value = cells[i + 1].textContent.trim();
                            data[key] = value;
                        }
                    }
                });
            });

            return data;
        }

        /**
         * Muestra los resultados de la comparaci√≥n en las tablas
         * @param {Object} screenerFilters - Filtros del screener
         * @param {Object} stockData - Datos de la empresa
         * @param {string} ticker - Ticker de la empresa
         */
        function displayResults(screenerFilters, stockData, ticker) {
            // Tabla de filtros del screener
            const screenerTable = document.querySelector('#screener-filters tbody');
            screenerTable.innerHTML = '';

            Object.entries(screenerFilters).forEach(([name, info]) => {
                const row = screenerTable.insertRow();
                row.innerHTML = `
                    <td><strong>${name}</strong></td>
                    <td>${info.value}</td>
                `;
            });

            // Tabla de comparaci√≥n
            const comparisonTable = document.querySelector('#comparison-table tbody');
            comparisonTable.innerHTML = '';

            Object.entries(screenerFilters).forEach(([name, info]) => {
                const stockValue = stockData[info.selector] || 'N/A';
                const row = comparisonTable.insertRow();

                // Determinar si coincide (simplificado)
                const matches = stockValue !== 'N/A';
                row.className = matches ? 'match' : 'no-match';

                row.innerHTML = `
                    <td><strong>${name}</strong></td>
                    <td>${info.value}</td>
                    <td>${stockValue}</td>
                    <td>${matches ? '‚úÖ Disponible' : '‚ùå No disponible'}</td>
                `;
            });
        }
    </script>
</body>

</html>